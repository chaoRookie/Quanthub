# QuantHub 数据库协作指南

**负责人**: 吴俊宏  
**更新时间**: 2025-11-30  
**面向对象**: 后端开发（冯皓岩）、前端开发（金双科）

---

## 一、我已经完成的工作

### 1.1 数据库模型设计 (`backend/models.py`)

我已经创建了 **5 张核心数据表**，涵盖用户、行情、策略和回测：

| 表名 | 用途 | 关键字段 |
|------|------|---------|
| `User` | 用户管理 | username, email, password |
| `MarketDataDaily` | 日线行情 | ts_code, trade_date, open, close, vol |
| `Strategy` | 策略仓库 | title, user, fork_from |
| `StrategyVersion` | 代码版本 | strategy, version_tag, code_content |
| `BacktestRecord` | 回测结果 | strategy_version, annual_return, chart_data |

### 1.2 数据加载脚本 (`backend/data_loader.py`)

提供了自动化数据抓取功能，支持从 Tushare 批量拉取 A 股历史数据。

### 1.3 验证脚本 (`scripts/verify_db.py`)

用于检查数据库完整性和数据质量。

---

## 二、后端开发需要知道的接口

### 2.1 查询行情数据

```python
from backend.models import MarketDataDaily

# 查询某只股票的历史数据
stock_data = MarketDataDaily.objects.filter(ts_code='000001.SZ').order_by('trade_date')

# 查询某个时间段
from datetime import date
data = MarketDataDaily.objects.filter(
    ts_code='000001.SZ',
    trade_date__gte=date(2023, 1, 1),
    trade_date__lte=date(2023, 12, 31)
)
```

### 2.2 创建策略和版本

```python
from backend.models import Strategy, StrategyVersion

# 创建策略
strategy = Strategy.objects.create(
    title="双均线策略",
    description="基于MA5和MA20的交叉策略",
    user=request.user,
    is_public=True
)

# 保存代码版本（每次保存都是新记录）
version = StrategyVersion.objects.create(
    strategy=strategy,
    version_tag="v1.0",
    code_content="def strategy():\n    pass",
    commit_message="初始版本"
)
```

### 2.3 保存回测结果

```python
from backend.models import BacktestRecord
from decimal import Decimal

# 创建回测记录
backtest = BacktestRecord.objects.create(
    strategy_version=version,
    annual_return=Decimal('15.20'),
    max_drawdown=Decimal('8.50'),
    sharpe_ratio=Decimal('1.5000'),
    chart_data={
        "dates": ["2023-01-01", "2023-01-02", ...],
        "values": [1.0, 1.02, 1.05, ...]
    },
    trade_log=[
        {"date": "2023-01-05", "action": "buy", "price": 10.5},
        {"date": "2023-01-10", "action": "sell", "price": 11.2}
    ]
)
```

**重要提示**:
- 金额字段必须使用 `Decimal` 类型，严禁使用 float
- `chart_data` 和 `trade_log` 是 JSON 格式，前端可以直接用

---

## 三、前端开发需要知道的数据格式

### 3.1 策略列表 API 返回格式（示例）

```json
{
  "strategies": [
    {
      "id": 1,
      "title": "双均线策略",
      "user": "冯皓岩",
      "return": "15.20",
      "created_at": "2024-01-01T10:00:00Z"
    }
  ]
}
```

### 3.2 回测结果图表数据

`BacktestRecord.chart_data` 的格式:
```json
{
  "dates": ["2023-01-01", "2023-01-02", ...],
  "values": [1.0, 1.02, 1.05, ...]
}
```

你可以直接用这个数据渲染 ECharts 净值曲线。

---

## 四、团队协作流程

### 4.1 我修改数据库时

当我需要添加字段或修改表结构时：

1. 我修改 `backend/models.py`
2. 运行 `python manage.py makemigrations`
3. 提交代码到 Git（包含 migration 文件）

### 4.2 你们拉取代码后

1. 拉取我的代码: `git pull`
2. 应用数据库变更: `python manage.py migrate`
3. 数据库自动同步，无需手动操作

**这个机制保证大家的数据库结构永远一致！**

---

## 五、常见问题

### Q1: 为什么不能用 Float 存价格？
**A**: Float 有精度问题，`0.1 + 0.2` 可能等于 `0.30000000000000004`。金融计算必须用 `Decimal`。

### Q2: 我想加新字段怎么办？
**A**: 联系我，我会统一在 `models.py` 里加，然后生成 migration。

### Q3: 如何快速查看数据库内容？
**A**: 
```bash
python manage.py shell
>>> from backend.models import MarketDataDaily
>>> MarketDataDaily.objects.count()
```

---

## 六、下一步计划

- [ ] 后端（冯皓岩）：编写 API 接口（`/api/strategies`, `/api/backtest`）
- [ ] 前端（金双科）：对接 API，渲染策略列表和图表
- [ ] 我（吴俊宏）：监控数据质量，优化查询性能

有问题随时找我！
